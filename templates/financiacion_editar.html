{% extends "base.html" %}

{% block title %}Editar Convocatorias - Dashboard de Financiación{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="text-primary text-center">Gestión Manual de Convocatorias</h1>
            <p class="text-center lead">Buscar, editar y eliminar convocatorias existentes</p>
        </div>
    </div>

    <!-- Barra de navegación -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="btn-group w-100" role="group">
                <a href="{{ url_for('gestionar_convocatorias') }}" class="btn btn-outline-primary">
                    <i class="fas fa-plus-circle me-2"></i>Añadir desde BDNS
                </a>
                <a href="{{ url_for('editar_convocatorias') }}" class="btn btn-primary">
                    <i class="fas fa-edit me-2"></i>Gestión Manual
                </a>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="fas fa-search me-2"></i>Buscar Convocatorias</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="text" class="form-control" id="search-input" placeholder="Nombre, BDNS...">
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filter-organismo">
                        <option value="">Todos organismos</option>
                        {% for organismo in filter_options.organismos %}
                            <option value="{{ organismo }}">{{ organismo }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filter-estado">
                        <option value="">Todos estados</option>
                        {% for estado in filter_options.estados %}
                            <option value="{{ estado }}">{{ estado }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" id="btn-buscar">
                        <i class="fas fa-search me-1"></i>Buscar
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-success w-100" id="btn-nuevo">
                        <i class="fas fa-plus me-1"></i>Nueva Convocatoria
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla -->
    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">Resultados <span id="total" class="badge bg-secondary">0</span></h5>
        </div>
        <div class="card-body">
            <div id="loading" class="text-center d-none py-4">
                <div class="spinner-border"></div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Organismo</th>
                            <th>Estado</th>
                            <th>BDNS</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-body">
                        <tr><td colspan="5" class="text-center">Busca convocatorias para comenzar</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar (versión simplificada) -->
<div class="modal fade" id="modalEditar" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modalTitle">Editar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto">
                <input type="hidden" id="edit-id">

                <!-- Accordion para organizar campos -->
                <div class="accordion" id="editAccordion">
                    <!-- Sección 1: Información Básica -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBasica">
                                <i class="fas fa-info-circle text-primary me-2"></i>
                                1. Información Básica
                                <span class="text-danger ms-2">*</span>
                            </button>
                        </h2>
                        <div id="collapseBasica" class="accordion-collapse collapse show" data-bs-parent="#editAccordion">
                            <div class="accordion-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <i class="fas fa-tag text-primary"></i>
                                            Nombre Coloquial
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="edit-nombre" required placeholder="Ej: Programa FEDER Innova-Pyme">
                                        <small class="text-muted">Nombre de uso común</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <i class="fas fa-file-signature text-primary"></i>
                                            Nombre Oficial
                                        </label>
                                        <input type="text" class="form-control" id="edit-nombre-oficial" placeholder="Título oficial completo">
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">
                                            <i class="fas fa-barcode text-info"></i>
                                            Código BDNS
                                        </label>
                                        <input type="text" class="form-control" id="edit-bdns">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <i class="fas fa-building text-primary"></i>
                                            Organismo
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="edit-organismo" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">
                                            <i class="fas fa-hand-holding-usd text-success"></i>
                                            Tipo Ayuda
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="edit-tipo" required placeholder="Separar por comas">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">
                                            <i class="fas fa-globe-europe text-primary"></i>
                                            Ámbito
                                        </label>
                                        <input type="text" class="form-control" id="edit-ambito">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección 2: Estado y Fechas -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFechas">
                                <i class="fas fa-calendar text-primary me-2"></i>
                                2. Estado y Fechas
                            </button>
                        </h2>
                        <div id="collapseFechas" class="accordion-collapse collapse" data-bs-parent="#editAccordion">
                            <div class="accordion-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">
                                            <i class="fas fa-traffic-light text-warning"></i>
                                            Estado
                                        </label>
                                        <select class="form-select" id="edit-estado">
                                            <option>Abierta</option>
                                            <option>Cerrada</option>
                                            <option>Próxima apertura</option>
                                            <option>Cierre próximo</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">
                                            <i class="fas fa-calendar-plus text-success"></i>
                                            Fecha Apertura
                                        </label>
                                        <input type="date" class="form-control" id="edit-fecha-apertura">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">
                                            <i class="fas fa-calendar-times text-danger"></i>
                                            Fecha Cierre
                                        </label>
                                        <input type="date" class="form-control" id="edit-fecha-cierre">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección 3: Descripciones -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDescripcion">
                                <i class="fas fa-align-left text-primary me-2"></i>
                                3. Descripciones
                            </button>
                        </h2>
                        <div id="collapseDescripcion" class="accordion-collapse collapse" data-bs-parent="#editAccordion">
                            <div class="accordion-body">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label class="form-label">
                                            <i class="fas fa-file-alt text-primary"></i>
                                            Resumen Breve
                                        </label>
                                        <textarea class="form-control" id="edit-resumen" rows="2"></textarea>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">
                                            <i class="fas fa-align-left text-primary"></i>
                                            Descripción Detallada
                                        </label>
                                        <textarea class="form-control" id="edit-descripcion" rows="3"></textarea>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">
                                            <i class="fas fa-comment text-info"></i>
                                            Comentarios
                                        </label>
                                        <textarea class="form-control" id="edit-comentarios" rows="2" placeholder="Notas internas"></textarea>
                                        <small class="text-muted">Notas adicionales, observaciones, cambios importantes</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección 4: Clasificación -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseClasificacion">
                                <i class="fas fa-tags text-primary me-2"></i>
                                4. Clasificación
                            </button>
                        </h2>
                        <div id="collapseClasificacion" class="accordion-collapse collapse" data-bs-parent="#editAccordion">
                            <div class="accordion-body">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label class="form-label">
                                            <i class="fas fa-users text-primary"></i>
                                            Beneficiarios
                                        </label>
                                        <input type="text" class="form-control" id="edit-beneficiarios" placeholder="Seleccionar o escribir...">
                                        <small class="text-muted">Selecciona de las opciones o escribe para añadir nuevas. Presiona Enter para agregar.</small>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">
                                            <i class="fas fa-industry text-primary"></i>
                                            Sectores
                                        </label>
                                        <input type="text" class="form-control" id="edit-sectores" placeholder="Seleccionar o escribir...">
                                        <small class="text-muted">Selecciona de las opciones o escribe para añadir nuevas. Presiona Enter para agregar.</small>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">
                                            <i class="fas fa-project-diagram text-primary"></i>
                                            Tipo de Proyecto
                                        </label>
                                        <input type="text" class="form-control" id="edit-tipo-proyecto" placeholder="Seleccionar o escribir...">
                                        <small class="text-muted">Selecciona de las opciones o escribe para añadir nuevas. Presiona Enter para agregar.</small>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">
                                            <i class="fas fa-flag text-success"></i>
                                            Fondos Europeos
                                        </label>
                                        <input type="text" class="form-control" id="edit-origen-fondos" placeholder="Seleccionar o escribir...">
                                        <small class="text-muted">Selecciona de las opciones o escribe para añadir nuevas. Presiona Enter para agregar.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección 5: Requisitos y Gastos -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRequisitos">
                                <i class="fas fa-check-circle text-primary me-2"></i>
                                5. Requisitos y Gastos Subvencionables
                            </button>
                        </h2>
                        <div id="collapseRequisitos" class="accordion-collapse collapse" data-bs-parent="#editAccordion">
                            <div class="accordion-body">
                                <div class="row g-3">
                                    <div class="col-6">
                                        <label class="form-label">
                                            <i class="fas fa-list-check text-success"></i>
                                            Requisitos
                                        </label>
                                        <textarea class="form-control" id="edit-requisitos" rows="4" placeholder="Añadir cada requisito en una línea nueva"></textarea>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">
                                            <i class="fas fa-receipt text-success"></i>
                                            Gastos Subvencionables
                                        </label>
                                        <textarea class="form-control" id="edit-gastos-subvencionables" rows="4" placeholder="Personal, Equipamiento, Materiales..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección 6: Financiación -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFinanciacion">
                                <i class="fas fa-euro-sign text-success me-2"></i>
                                6. Información Financiera
                            </button>
                        </h2>
                        <div id="collapseFinanciacion" class="accordion-collapse collapse" data-bs-parent="#editAccordion">
                            <div class="accordion-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <i class="fas fa-percentage text-info"></i>
                                            Intensidad de Financiación
                                        </label>
                                        <input type="text" class="form-control" id="edit-intensidad" placeholder="Ej: 70%, Hasta 100%...">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <i class="fas fa-money-bill-wave text-success"></i>
                                            Presupuesto Total
                                        </label>
                                        <input type="text" class="form-control" id="edit-presupuesto-total" placeholder="60000000">
                                        <small class="text-muted">Dinero disponible total en la convocatoria</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <i class="fas fa-arrow-down text-info"></i>
                                            Presupuesto Mínimo del Proyecto
                                        </label>
                                        <input type="text" class="form-control" id="edit-presupuesto-minimo" placeholder="50000">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <i class="fas fa-arrow-up text-info"></i>
                                            Presupuesto Máximo del Proyecto
                                        </label>
                                        <input type="text" class="form-control" id="edit-presupuesto-maximo" placeholder="1000000">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <i class="fas fa-arrow-down text-success"></i>
                                            Importe Mínimo Subvencionable
                                        </label>
                                        <input type="text" class="form-control" id="edit-importe-minimo-subvencionable" placeholder="10000">
                                        <small class="text-muted">Ayuda mínima que se otorga</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <i class="fas fa-arrow-up text-success"></i>
                                            Importe Máximo Subvencionable
                                        </label>
                                        <input type="text" class="form-control" id="edit-importe-maximo-subvencionable" placeholder="500000">
                                        <small class="text-muted">Ayuda máxima que se otorga</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección 7: Enlaces -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEnlaces">
                                <i class="fas fa-link text-primary me-2"></i>
                                7. Enlaces y Documentación
                            </button>
                        </h2>
                        <div id="collapseEnlaces" class="accordion-collapse collapse" data-bs-parent="#editAccordion">
                            <div class="accordion-body">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label class="form-label">
                                            <i class="fas fa-database text-info"></i>
                                            URL BDNS
                                        </label>
                                        <input type="url" class="form-control" id="edit-url-bdns" placeholder="https://www.infosubvenciones.es/bdnstrans/...">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">
                                            <i class="fas fa-file-pdf text-danger"></i>
                                            URL Convocatoria (Resolución)
                                        </label>
                                        <input type="url" class="form-control" id="edit-url-convocatoria" placeholder="https://...">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">
                                            <i class="fas fa-gavel text-warning"></i>
                                            URL Bases Reguladoras
                                        </label>
                                        <input type="url" class="form-control" id="edit-url-bases" placeholder="https://...">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">
                                            <i class="fas fa-newspaper text-primary"></i>
                                            URL Extracto Oficial
                                        </label>
                                        <input type="url" class="form-control" id="edit-url-extracto" placeholder="https://www.boe.es/...">
                                        <small class="text-muted">Del BOE, DOGC, etc.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-guardar">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Eliminar -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5>Confirmar Eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Eliminar esta convocatoria?</p>
                <p class="fw-bold" id="del-nombre"></p>
                <input type="hidden" id="del-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btn-eliminar">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<!-- Tagify CSS y JS para tags input -->
<link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>

<!-- Opciones predefinidas -->
<script src="{{ url_for('static', filename='js/opciones_predefinidas.js') }}"></script>

<!-- Script principal -->
<script src="{{ url_for('static', filename='js/financiacion_editar.js') }}"></script>
{% endblock %}
