# üöÄ GU√çA COMPLETA DE DESPLIEGUE

## üìÖ PLAN DE 3 D√çAS

Esta gu√≠a te llevar√° paso a paso desde cero hasta tener la aplicaci√≥n en producci√≥n.

---

## ‚úÖ D√çA 1: PREPARACI√ìN (Completado)

### Ya has hecho:
- [x] Estructura del proyecto creada
- [x] Archivos copiados del monolito
- [x] C√≥digo funcionando en local
- [x] Pruebas locales completadas
- [x] Repositorio en GitHub creado
- [x] C√≥digo subido a GitHub

**Estado**: ‚úÖ Completado

---

## üéØ D√çA 2: DEPLOY (2-4 horas)

### Checklist del D√≠a 2

#### Parte 1: Contratar VPS (30 minutos)
- [ ] Leer: `CONTRATAR_HETZNER.md`
- [ ] Crear cuenta en Hetzner
- [ ] Contratar Hetzner CX21 (4.51‚Ç¨/mes)
- [ ] Anotar IP del servidor
- [ ] Crear SSH key
- [ ] Primera conexi√≥n exitosa
- [ ] Crear usuario `fade`

üìÑ **Documento**: `CONTRATAR_HETZNER.md`

---

#### Parte 2: Configurar VPS (30 minutos)

**Paso 1**: Conectar al VPS

```bash
# Desde tu PC (PowerShell)
ssh -i $HOME\.ssh\fade-hetzner fade@IP_DEL_SERVIDOR
```

**Paso 2**: Subir script de setup

Opci√≥n A - Clonar repositorio (recomendado):
```bash
# En el VPS
cd ~
git clone https://github.com/mecamira/fade-financiacion-lite.git
cd fade-financiacion-lite
```

Opci√≥n B - Subir script manualmente:
```powershell
# Desde tu PC
scp -i $HOME\.ssh\fade-hetzner scripts/setup-vps.sh fade@IP_SERVIDOR:~/
```

**Paso 3**: Ejecutar setup autom√°tico

```bash
# En el VPS
sudo bash scripts/setup-vps.sh
```

Este script instalar√° autom√°ticamente:
- ‚úÖ Docker y Docker Compose
- ‚úÖ Nginx
- ‚úÖ Certbot (para SSL)
- ‚úÖ Firewall configurado
- ‚úÖ Herramientas b√°sicas

‚è±Ô∏è **Duraci√≥n**: 5-10 minutos

**Paso 4**: Cerrar y reconectar

```bash
# Salir del VPS
exit

# Volver a conectar (para aplicar grupo docker)
ssh -i $HOME\.ssh\fade-hetzner fade@IP_DEL_SERVIDOR
```

---

#### Parte 3: Configurar aplicaci√≥n (20 minutos)

**Paso 1**: Entrar al directorio del proyecto

```bash
cd ~/fade-financiacion-lite
```

**Paso 2**: Crear archivo .env

```bash
# Copiar ejemplo
cp .env.example .env

# Editar con nano
nano .env
```

**Contenido del .env (IMPORTANTE - Usar valores reales)**:

```env
# Flask - PRODUCCI√ìN
FLASK_ENV=production
SECRET_KEY=PEGA_AQUI_LA_CLAVE_GENERADA_ABAJO

# Google Gemini AI
GEMINI_API_KEY=TU_API_KEY_REAL_DE_GEMINI

# Autenticaci√≥n Admin
ADMIN_PASSWORD=UNA_CONTRASE√ëA_MUY_SEGURA_PARA_ADMIN

# Base de datos
DATABASE_PATH=/app/data/programas_financiacion.json

# Selenium (Docker)
SELENIUM_REMOTE_URL=http://selenium:4444/wd/hub

# Logs
LOG_DIR=/app/logs
```

**Paso 3**: Generar SECRET_KEY segura

```bash
# Generar clave aleatoria
python3 -c 'import secrets; print(secrets.token_hex(32))'

# Copiar el resultado y pegarlo en SECRET_KEY en el archivo .env
```

**Paso 4**: Guardar archivo .env

- Presiona `Ctrl + O` ‚Üí Enter (para guardar)
- Presiona `Ctrl + X` (para salir)

**Paso 5**: Verificar .env

```bash
# Ver el archivo (sin mostrar contrase√±as)
cat .env
```

---

#### Parte 4: Desplegar aplicaci√≥n (10 minutos)

**Ejecutar script de deploy**:

```bash
# En el VPS, dentro del directorio del proyecto
bash scripts/deploy.sh
```

Este script har√° autom√°ticamente:
1. ‚úÖ Verificar configuraci√≥n (.env)
2. ‚úÖ Verificar Docker
3. ‚úÖ Detener contenedores antiguos (si existen)
4. ‚úÖ Construir im√°genes Docker (5-10 min)
5. ‚úÖ Crear directorios necesarios
6. ‚úÖ Iniciar contenedores
7. ‚úÖ Verificar que funciona
8. ‚úÖ Mostrar logs iniciales

‚è±Ô∏è **Duraci√≥n**: 5-10 minutos (construcci√≥n de im√°genes)

**Resultado esperado**:

```
==================================
‚úÖ DEPLOY COMPLETADO
==================================

üåê Aplicaci√≥n disponible en:
  - Local: http://localhost:8000
  - Servidor: http://TU_IP:8000

üîç Comandos √∫tiles:
  - Ver logs:      docker compose logs -f
  - Ver estado:    docker compose ps
  - Reiniciar:     docker compose restart
  - Detener:       docker compose down
```

---

#### Parte 5: Verificar funcionamiento (10 minutos)

**Paso 1**: Acceder desde el navegador

```
http://TU_IP_DEL_SERVIDOR:8000
```

**Paso 2**: Checklist de verificaci√≥n

- [ ] Dashboard p√∫blico carga
- [ ] Se ven los programas de financiaci√≥n
- [ ] Los filtros funcionan
- [ ] Login admin funciona (http://TU_IP:8000/admin/login)
- [ ] Panel de gesti√≥n accesible
- [ ] No hay errores en los logs

**Ver logs en tiempo real**:

```bash
docker compose logs -f
```

(Presiona `Ctrl + C` para salir)

---

#### Parte 6: Configurar Nginx (Opcional - 15 minutos)

Si quieres usar el puerto 80 (HTTP est√°ndar) en lugar del 8000.

**Crear configuraci√≥n de Nginx**:

```bash
sudo nano /etc/nginx/sites-available/fade-financiacion
```

**Contenido**:

```nginx
server {
    listen 80;
    server_name TU_IP_DEL_SERVIDOR;

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts para operaciones largas (IA, scraping)
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;
    }
}
```

**Activar configuraci√≥n**:

```bash
# Crear enlace simb√≥lico
sudo ln -s /etc/nginx/sites-available/fade-financiacion /etc/nginx/sites-enabled/

# Eliminar configuraci√≥n por defecto
sudo rm /etc/nginx/sites-enabled/default

# Verificar configuraci√≥n
sudo nginx -t

# Recargar Nginx
sudo systemctl reload nginx
```

**Ahora accesible en**:
```
http://TU_IP_DEL_SERVIDOR
```

---

#### Parte 7: Configurar Dominio (Opcional - 20 minutos)

Solo si tienes un dominio (ej: financiacion.fade.es)

**Paso 1**: Configurar DNS

En tu proveedor de dominios (donde compraste el dominio), crea un registro A:

```
Tipo: A
Nombre: financiacion (o @ para el dominio ra√≠z)
Valor: TU_IP_DEL_SERVIDOR
TTL: 3600 (o autom√°tico)
```

**Paso 2**: Esperar propagaci√≥n DNS (5-30 minutos)

Verificar:
```bash
# Desde tu PC
nslookup financiacion.tudominio.com
```

**Paso 3**: Actualizar configuraci√≥n Nginx

```bash
sudo nano /etc/nginx/sites-available/fade-financiacion
```

Cambiar l√≠nea `server_name`:

```nginx
server_name financiacion.tudominio.com www.financiacion.tudominio.com;
```

Recargar:
```bash
sudo nginx -t
sudo systemctl reload nginx
```

---

#### Parte 8: Configurar SSL/HTTPS (Opcional - 10 minutos)

Solo si configuraste un dominio en el paso anterior.

**Obtener certificado SSL gratuito**:

```bash
sudo certbot --nginx -d financiacion.tudominio.com
```

Certbot preguntar√°:
1. **Email**: Tu email (para avisos de renovaci√≥n)
2. **T√©rminos**: Escribe `A` (aceptar)
3. **Redirect HTTP ‚Üí HTTPS**: Escribe `2` (s√≠, redirigir)

**¬°Listo! Ahora tienes HTTPS** üîí:
```
https://financiacion.tudominio.com
```

**Renovaci√≥n autom√°tica**:

Certbot configura renovaci√≥n autom√°tica. Verificar:

```bash
sudo certbot renew --dry-run
```

---

### üìä Resumen del D√≠a 2

Al final del D√≠a 2 deber√≠as tener:

- ‚úÖ VPS Hetzner contratado y configurado
- ‚úÖ Docker instalado
- ‚úÖ Aplicaci√≥n desplegada y funcionando
- ‚úÖ Accesible desde internet (http://TU_IP:8000)
- ‚úÖ Nginx configurado (opcional)
- ‚úÖ Dominio configurado (opcional)
- ‚úÖ SSL/HTTPS activo (opcional)

---

## üîç D√çA 3: VALIDACI√ìN Y OPTIMIZACI√ìN (2 horas)

### Checklist del D√≠a 3

#### Parte 1: Pruebas funcionales completas (30 minutos)

**1. Dashboard p√∫blico**
- [ ] Acceder a la home
- [ ] Buscar programas con diferentes filtros
- [ ] Ver detalles de un programa
- [ ] Verificar que las im√°genes cargan
- [ ] Probar en m√≥vil (responsive)

**2. Panel de administraci√≥n**
- [ ] Login con contrase√±a admin
- [ ] Ver lista de programas
- [ ] Crear programa nuevo
- [ ] Editar programa existente
- [ ] Eliminar programa de prueba

**3. Extracci√≥n con Gemini AI**
- [ ] Pegar texto de una convocatoria
- [ ] Verificar que extrae la informaci√≥n
- [ ] Guardar el programa extra√≠do
- [ ] Verificar que aparece en el dashboard

**4. An√°lisis de compatibilidad**
- [ ] Acceder a /financiacion/analizar-compatibilidad
- [ ] Completar formulario empresa
- [ ] Seleccionar convocatoria
- [ ] Generar an√°lisis
- [ ] Verificar que el an√°lisis tiene sentido

**5. Scraping BDNS (si funciona)**
- [ ] Probar b√∫squeda en BDNS
- [ ] Verificar que encuentra resultados
- [ ] Importar convocatoria

---

#### Parte 2: Configurar backups (20 minutos)

**Script de backup autom√°tico**:

```bash
# Crear script
nano ~/backup-fade.sh
```

**Contenido**:

```bash
#!/bin/bash
# Backup autom√°tico FADE Financiaci√≥n

BACKUP_DIR="$HOME/backups"
PROJECT_DIR="$HOME/fade-financiacion-lite"
DATE=$(date +%Y%m%d-%H%M%S)

# Crear directorio de backups
mkdir -p $BACKUP_DIR

# Backup del JSON de programas
cp $PROJECT_DIR/data/programas_financiacion.json \
   $BACKUP_DIR/programas-$DATE.json

# Backup de logs (comprimir)
tar -czf $BACKUP_DIR/logs-$DATE.tar.gz \
   $PROJECT_DIR/logs/

# Mantener solo los √∫ltimos 7 backups
cd $BACKUP_DIR
ls -t programas-*.json | tail -n +8 | xargs rm -f
ls -t logs-*.tar.gz | tail -n +8 | xargs rm -f

echo "Backup completado: $DATE"
```

**Hacer ejecutable**:

```bash
chmod +x ~/backup-fade.sh
```

**Configurar cron (backup diario a las 3 AM)**:

```bash
# Editar crontab
crontab -e

# A√±adir l√≠nea (al final del archivo):
0 3 * * * /home/fade/backup-fade.sh >> /home/fade/backup.log 2>&1
```

**Probar backup manual**:

```bash
bash ~/backup-fade.sh
ls -lh ~/backups/
```

---

#### Parte 3: Monitorizaci√≥n b√°sica (15 minutos)

**Ver uso de recursos**:

```bash
# CPU y RAM de contenedores
docker stats

# Espacio en disco
df -h

# Ver logs en tiempo real
docker compose logs -f app
```

**Script de health check**:

```bash
nano ~/check-fade.sh
```

**Contenido**:

```bash
#!/bin/bash
# Health check FADE Financiaci√≥n

echo "=== FADE Health Check ==="
echo "Fecha: $(date)"
echo ""

# Verificar contenedores
echo "Contenedores:"
docker compose -f ~/fade-financiacion-lite/docker-compose.yml ps
echo ""

# Verificar respuesta HTTP
echo "HTTP Check:"
if curl -f http://localhost:8000 > /dev/null 2>&1; then
    echo "‚úÖ Aplicaci√≥n responde OK"
else
    echo "‚ùå Aplicaci√≥n NO responde"
fi
echo ""

# Uso de disco
echo "Espacio en disco:"
df -h / | grep -v "Filesystem"
echo ""

# Memoria
echo "Memoria:"
free -h | grep -E "Mem:|Swap:"
```

**Hacer ejecutable y probar**:

```bash
chmod +x ~/check-fade.sh
bash ~/check-fade.sh
```

---

#### Parte 4: Documentaci√≥n para FADE (30 minutos)

**Crear documento de operaciones**:

```bash
nano ~/OPERACIONES_FADE.md
```

**Contenido**:

```markdown
# üìñ FADE Financiaci√≥n - Gu√≠a de Operaciones

## üåê Accesos

- **URL P√∫blica**: http://TU_IP_O_DOMINIO
- **Panel Admin**: http://TU_IP_O_DOMINIO/admin/login
- **Contrase√±a Admin**: [GUARDADA EN LUGAR SEGURO]

## üîê Acceso SSH

```bash
ssh -i ~/.ssh/fade-hetzner fade@TU_IP
```

## üîß Comandos √ötiles

### Ver estado
```bash
cd ~/fade-financiacion-lite
docker compose ps
```

### Ver logs
```bash
docker compose logs -f
```

### Reiniciar aplicaci√≥n
```bash
docker compose restart
```

### Detener aplicaci√≥n
```bash
docker compose down
```

### Iniciar aplicaci√≥n
```bash
docker compose up -d
```

### Ver uso de recursos
```bash
docker stats
```

## üîÑ Actualizar aplicaci√≥n

```bash
cd ~/fade-financiacion-lite
docker compose down
git pull origin main
docker compose build
docker compose up -d
```

## üíæ Backups

Los backups se ejecutan autom√°ticamente cada d√≠a a las 3 AM.

Ver backups:
```bash
ls -lh ~/backups/
```

Backup manual:
```bash
bash ~/backup-fade.sh
```

## üÜò Problemas Comunes

### La aplicaci√≥n no responde
```bash
# Ver logs
docker compose logs app

# Reiniciar
docker compose restart app
```

### Contenedores no inician
```bash
# Ver errores
docker compose logs

# Verificar .env
cat .env
```

### Disco lleno
```bash
# Ver espacio
df -h

# Limpiar Docker
docker system prune -a
```

## üìû Soporte T√©cnico

- **Hetzner Support**: support@hetzner.com
- **GitHub Repo**: https://github.com/mecamira/fade-financiacion-lite
```

---

#### Parte 5: Optimizaciones (30 minutos)

**1. Configurar logs rotativos**

```bash
sudo nano /etc/logrotate.d/fade-financiacion
```

**Contenido**:

```
/home/fade/fade-financiacion-lite/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
}
```

**2. Ajustar Docker para producci√≥n**

Editar `docker-compose.yml`:

```bash
nano ~/fade-financiacion-lite/docker-compose.yml
```

A√±adir restart policies y limites de recursos:

```yaml
services:
  app:
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          memory: 512M
  
  selenium:
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          memory: 512M
```

Aplicar cambios:

```bash
docker compose down
docker compose up -d
```

**3. Configurar alertas por email (opcional)**

Instalar mailutils:

```bash
sudo apt install -y mailutils
```

Script de alerta:

```bash
nano ~/alert-fade.sh
```

**Contenido**:

```bash
#!/bin/bash
# Alerta si la aplicaci√≥n no responde

if ! curl -f http://localhost:8000 > /dev/null 2>&1; then
    echo "ALERTA: FADE Financiaci√≥n no responde" | \
    mail -s "FADE Down" tu-email@fade.es
fi
```

A√±adir a crontab (check cada 15 min):

```bash
crontab -e

# A√±adir:
*/15 * * * * /home/fade/alert-fade.sh
```

---

### üìä Resumen del D√≠a 3

Al final del D√≠a 3 deber√≠as tener:

- ‚úÖ Todas las funcionalidades probadas
- ‚úÖ Backups autom√°ticos configurados
- ‚úÖ Monitorizaci√≥n b√°sica
- ‚úÖ Documentaci√≥n para operaciones
- ‚úÖ Logs rotativos configurados
- ‚úÖ Optimizaciones aplicadas
- ‚úÖ Sistema de alertas (opcional)

---

## üéØ CHECKLIST FINAL COMPLETO

### Infraestructura
- [ ] VPS contratado y pagado
- [ ] Docker instalado y funcionando
- [ ] Firewall configurado
- [ ] Nginx instalado (opcional)
- [ ] SSL/HTTPS activo (opcional)

### Aplicaci√≥n
- [ ] C√≥digo desplegado
- [ ] Variables de entorno configuradas
- [ ] Contenedores corriendo
- [ ] Aplicaci√≥n accesible desde internet
- [ ] Panel admin funcional

### Funcionalidades
- [ ] Dashboard p√∫blico funciona
- [ ] B√∫squeda y filtros funcionan
- [ ] Login admin funciona
- [ ] Gesti√≥n de programas funciona
- [ ] Extracci√≥n Gemini funciona
- [ ] An√°lisis compatibilidad funciona
- [ ] Scraping BDNS funciona (opcional)

### Seguridad y Operaciones
- [ ] Contrase√±a admin fuerte
- [ ] SSH con clave (no contrase√±a)
- [ ] Firewall activo
- [ ] Backups autom√°ticos
- [ ] Logs configurados
- [ ] Documentaci√≥n lista

---

## üìû CONTACTOS Y RECURSOS

### Proveedores
- **Hetzner**: https://console.hetzner.cloud/
- **Hetzner Support**: support@hetzner.com

### Documentaci√≥n
- **Docker**: https://docs.docker.com/
- **Nginx**: https://nginx.org/en/docs/
- **Certbot**: https://certbot.eff.org/

### Repositorio
- **GitHub**: https://github.com/mecamira/fade-financiacion-lite

---

## üéâ ¬°ENHORABUENA!

Si has completado todos los pasos, ahora tienes:

‚úÖ Una aplicaci√≥n Flask en producci√≥n  
‚úÖ Con Docker y contenedores  
‚úÖ Accesible desde internet  
‚úÖ Con HTTPS (si configuraste dominio)  
‚úÖ Con backups autom√°ticos  
‚úÖ Monitoreada y documentada  

**¬°Tu proyecto est√° en producci√≥n!** üöÄ

---

**Versi√≥n**: 1.0.0  
**Fecha**: 2025-10-11  
**Tiempo total estimado**: 6-12 horas  
**Coste mensual**: ~4.51‚Ç¨/mes
